{"pageProps":{"data":{"category":null,"content":"\n\n首先吐槽一下又拍云的文档，需要有亿点改进。\n\n由于我是前端上传，官网没有js sdk，所以需要结合后端来生成签名和policy。\n\n前端使用的是form api的方式上传。\n\n\n\n### 后端\n\n直接上后端代码（golang）：\n\n```go\npackage application\n\nimport (\n\t\"crypto/hmac\"\n\t\"crypto/md5\"\n\t\"crypto/sha1\"\n\t\"encoding/base64\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"strings\"\n\t\"time\"\n)\n\ntype Upyun struct {\n\tToken  string `json:\"token\"`\n\tDate   string `json:\"date\"`\n\tPolicy string `json:\"policy\"`\n}\n\nfunc makeSaveKey() string {\n\treturn \"/{year}/{mon}/{day}/upload_{random32}{.suffix}\"\n}\n\nfunc makePolicy(bucket, saveKey string) string {\n  // 过期时间设置为一天。\n\texpiration := time.Now().AddDate(0, 0, 1).Unix()\n\tobj := struct {\n\t\tBucket     string `json:\"bucket\"`\n\t\tSaveKey    string `json:\"save-key\"`\n\t\tExpiration int64  `json:\"expiration\"`\n\t\t// Date       string `json:\"date\"`\n\t}{\n\t\tBucket:     bucket,\n\t\tSaveKey:    saveKey,\n\t\tExpiration: expiration,\n\t\t// Date:       date,\n\t}\n\n\tstr, err := json.Marshal(&obj)\n\tif err != nil {\n\t\treturn \"\"\n\t}\n\n\tsEnc := base64.StdEncoding.EncodeToString([]byte(str))\n\treturn sEnc\n}\n\nfunc md5Str(s string) string {\n\treturn fmt.Sprintf(\"%x\", md5.Sum([]byte(s)))\n}\nfunc makeRFC1123Date(d time.Time) string {\n\tutc := d.UTC().Format(time.RFC1123)\n\treturn strings.Replace(utc, \"UTC\", \"GMT\", -1)\n}\nfunc base64ToStr(b []byte) string {\n\treturn base64.StdEncoding.EncodeToString(b)\n}\nfunc sign(key, secret, method, uri, date, policy, md5 string) string {\n\tmac := hmac.New(sha1.New, []byte(secret))\n\telems := []string{}\n\tfor _, v := range []string{method, uri, date, policy, md5} {\n\t\tif v != \"\" {\n\t\t\telems = append(elems, v)\n\t\t}\n\t}\n\tvalue := strings.Join(elems, \"&\")\n\tmac.Write([]byte(value))\n\tsignStr := base64ToStr(mac.Sum(nil))\n\treturn \"UPYUN \" + key + \":\" + signStr\n}\n\nfunc GetUpyunToken(key, secret, bucket, method string) *Upyun {\n\tdate := makeRFC1123Date(time.Now())\n\tsaveKey := makeSaveKey()\n\tpolicy := makePolicy(bucket, saveKey)\n\ttoken := sign(key, md5Str(secret), method, \"/\"+bucket, \"\", policy, \"\")\n\n\tupyun := Upyun{\n\t\tDate:   date,\n\t\tToken:  token,\n\t\tPolicy: policy,\n\t}\n\n\treturn &upyun\n}\n\n```\n\n说说遇到的坑，\n\n1. 签名和policy中不要设置date数据，不然前端上传时的时间与签名和policy中的时间对不上。\n\n2. 调用**sign**方法时method参数后一个参数在拼接时需要加上/，不然签名不对，比如下面这样。\n\n   ```\n   method&/uri&policy\n   ```\n\n上面的问题是在客服技术人员的耐心指导下调通的。在此感谢技术大佬。\n\n\n\n### 前端\n\n前端使用的antd的upload组件，\n\n```jsx\n<Upload\n  name=\"file\"\n  method={'POST'}\n  listType=\"picture-card\"\n  className=\"avatar-uploader\"\n  showUploadList={false}\n  action={`https://v0.api.upyun.com/${bucketName}`}\n  beforeUpload={beforeUpload}\n  onChange={handleChange}\n  data={{\n    authorization: xxxx,\n    policy: xxx,\n  }}\n  >\n  {value ? <img src={value} alt=\"avatar\" style={{width: '100%'}} /> : uploadButton}\n</Upload>\n```\n\n\n\n由于签名需要涉及到密码，放在服务器上生成比较安全，前端使用即可。\n\n\n\n\n\n","createTime":1657503681084,"creativeType":"original","description":"\n\n首先吐槽一下又拍云的文档，需要有亿点改进。\n\n由于我是前端上传，官网没有js sdk，所以需要结合后端来生成签名和policy。\n\n前端使用的是form api的方式上传。\n\n\n\n 后端\n\n直接上后端代码（golang）：\n\ngo\npackage application\n\nimport (\n\t\"crypto/hmac\"\n\t\"crypto/md5\"\n\t\"crypto/sha1\"\n\t\"","headerImg":"//file.vwood.xyz/2022/07/11/upload_zowr0rxe5g7imar24xz5tfxpzcnylz8h.jpg","id":"f6ea6c70-76ba-40fa-9f5b-792afbf7fe8b","isDeleted":false,"likeCount":0,"name":"记又拍云接入过程","operator":{"avatar":"//file.vwood.xyz/2022/07/13/upload_xtola9p0z8ctzyg5g014tfmjkokb7ydq.jpg","description":"一个懒惰、躺平的程序员","github":"https://github.com/abelce","id":"96f16846-31f2-489c-9af0-d4ca13e836e4","name":"文钦"},"operatorID":"96f16846-31f2-489c-9af0-d4ca13e836e4","tags":["又拍云","签名","policy"],"updateTime":1657503835129,"viewCount":49},"id":"f6ea6c70-76ba-40fa-9f5b-792afbf7fe8b","latestArticleList":[{"id":"67eb1db1-28cf-4ae6-9263-5aea9cb8b55e","name":"css伪类:not用法","tags":[],"description":"","content":""},{"id":"38abab46-1f1d-47e0-9f3d-aeafdf41a0e7","name":"js 实现 LRU缓存","tags":[],"description":"","content":""},{"id":"02eea954-494c-4c35-8f80-d34e70f87807","name":"低代码文章收集","tags":[],"description":"","content":""},{"id":"f6ea6c70-76ba-40fa-9f5b-792afbf7fe8b","name":"记又拍云接入过程","tags":[],"description":"","content":""},{"id":"281b0b57-0e7e-4033-bcad-8b886535e127","name":"chrome文字定位与::target-text样式设置","tags":[],"description":"","content":""}]},"initialMobxState":{"userStore":{"currentUser":null,"users":[],"token":"","qiniuToken":"","userCount":0,"productCount":0,"commentCount":0,"settingType":"products"},"productStore":{},"commentStore":{},"noteStore":{},"askStore":{},"stypeStore":{}},"__N_SSG":true}